<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindScan Pro - Comprehensive Mental Health Assessment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 80px rgba(0,0,0,0.2);
        }
        
        .header {
            text-align: center;
            padding: 40px 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 20px;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .page {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            border-left: 5px solid #3498db;
            transition: all 0.3s ease;
        }
        
        .section:hover {
            background: linear-gradient(135deg, #e9ecef, #dee2e6);
            transform: translateX(5px);
        }
        
        .critical-section {
            border-left-color: #e74c3c;
            background: linear-gradient(135deg, #fdf2f2, #fef5f5);
        }
        
        .section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
            font-size: 0.95em;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            transform: translateY(-1px);
        }
        
        .form-input:hover {
            border-color: #bdc3c7;
        }
        
        .range-container {
            position: relative;
            margin: 15px 0;
        }
        
        .range-input {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, #e74c3c, #f39c12, #2ecc71);
            outline: none;
            -webkit-appearance: none;
        }
        
        .range-input::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        .range-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .range-value {
            text-align: center;
            font-weight: bold;
            color: #3498db;
            font-size: 18px;
            margin-top: 8px;
            padding: 5px 10px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 8px;
            display: inline-block;
        }
        
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .checkbox-item:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
        }
        
        .checkbox-item input:checked + label {
            color: #3498db;
            font-weight: bold;
        }
        
        .checkbox-item input {
            margin-right: 10px;
            transform: scale(1.2);
        }
        
        .scenario-box {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
            position: relative;
        }
        
        .scenario-box::before {
            content: "üí≠";
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
        }
        
        .critical-question {
            background: linear-gradient(135deg, #fff5f5, #fef2f2);
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border: 2px solid #fed7d7;
            position: relative;
        }
        
        .critical-question::before {
            content: "‚ö†Ô∏è";
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 25px rgba(52, 152, 219, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        
        .progress-container {
            background: #ecf0f1;
            border-radius: 25px;
            padding: 4px;
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 12px;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 20px;
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding: 20px 0;
        }
        
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
        }
        
        .disclaimer {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 2px solid #f39c12;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
        }
        
        .disclaimer::before {
            content: "üìÑ";
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
        }
        
        .results-container {
            display: none;
            margin-top: 30px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s ease;
            border-left: 5px solid #3498db;
        }
        
        .metric-card:hover {
            transform: scale(1.05);
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .family-member {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #3498db;
        }
        
        .tooltip {
            position: relative;
            cursor: help;
        }
        
        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            white-space: nowrap;
            z-index: 1000;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Authentication Page -->
        <div id="authPage" class="page active">
            <div class="header">
                <h1>üß† MindScan Pro</h1>
                <p>Advanced Psychological Assessment Platform</p>
            </div>
            
            <div class="card auth-container">
                <div id="loginForm">
                    <h3 style="text-align: center; margin-bottom: 20px;">Sign In to Your Account</h3>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="loginEmail" class="form-input" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password">
                    </div>
                    <button onclick="signIn()" class="btn" style="width: 100%;">Sign In</button>
                    <p style="text-align: center; margin-top: 15px;">
                        Don't have an account? <a href="#" onclick="showRegister()" style="color: #3498db;">Register here</a>
                    </p>
                </div>
                
                <div id="registerForm" style="display: none;">
                    <h3 style="text-align: center; margin-bottom: 20px;">Create New Account</h3>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="registerEmail" class="form-input" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="registerPassword" class="form-input" placeholder="Create a password">
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" id="confirmPassword" class="form-input" placeholder="Confirm your password">
                    </div>
                    <button onclick="signUp()" class="btn" style="width: 100%;">Create Account</button>
                    <p style="text-align: center; margin-top: 15px;">
                        Already have an account? <a href="#" onclick="showLogin()" style="color: #3498db;">Sign in here</a>
                    </p>
                </div>
                
                <div class="disclaimer">
                    <h4>üìÑ Data Usage Disclaimer</h4>
                    <p>By creating an account, you acknowledge that:</p>
                    <ul style="margin: 10px 0 0 20px;">
                        <li>Your data may be used for research and study purposes only</li>
                        <li>All personal information will be anonymized for research</li>
                        <li>Data will be securely stored and protected</li>
                        <li>You can request data deletion at any time</li>
                        <li>This platform is for assessment purposes, not medical diagnosis</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Personal Information Page -->
        <div id="personalInfoPage" class="page">
            <div class="header">
                <h1>üìã Personal Information</h1>
                <p>Help us understand your background for personalized assessment</p>
            </div>
            
            <div class="card">
                <div class="progress-container">
                    <div class="progress-bar" id="personalProgress"></div>
                </div>
                <div class="progress-text">Step 1 of 3 - Personal Details</div>
                
                <form id="personalInfoForm">
                    <div class="section">
                        <h3>üë§ Basic Information</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div class="form-group">
                                <label>Full Name *</label>
                                <input type="text" id="fullName" class="form-input" required placeholder="Enter your full name">
                            </div>
                            
                            <div class="form-group">
                                <label>Age *</label>
                                <input type="number" id="age" class="form-input" required min="13" max="100" placeholder="Your age">
                            </div>
                            
                            <div class="form-group">
                                <label>Gender</label>
                                <select id="gender" class="form-input">
                                    <option value="">Select Gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="non-binary">Non-binary</option>
                                    <option value="prefer-not-to-say">Prefer not to say</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Religion</label>
                                <select id="religion" class="form-input">
                                    <option value="">Select Religion</option>
                                    <option value="christianity">Christianity</option>
                                    <option value="islam">Islam</option>
                                    <option value="hinduism">Hinduism</option>
                                    <option value="buddhism">Buddhism</option>
                                    <option value="judaism">Judaism</option>
                                    <option value="sikhism">Sikhism</option>
                                    <option value="atheist">Atheist</option>
                                    <option value="agnostic">Agnostic</option>
                                    <option value="other">Other</option>
                                    <option value="prefer-not-to-say">Prefer not to say</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Ethnic Background</label>
                                <select id="ethnicity" class="form-input">
                                    <option value="">Select Ethnicity</option>
                                    <option value="asian">Asian</option>
                                    <option value="black-african">Black/African</option>
                                    <option value="white-caucasian">White/Caucasian</option>
                                    <option value="hispanic-latino">Hispanic/Latino</option>
                                    <option value="middle-eastern">Middle Eastern</option>
                                    <option value="mixed-race">Mixed Race</option>
                                    <option value="native-american">Native American</option>
                                    <option value="pacific-islander">Pacific Islander</option>
                                    <option value="other">Other</option>
                                    <option value="prefer-not-to-say">Prefer not to say</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Country *</label>
                                <input type="text" id="country" class="form-input" required placeholder="Your country">
                            </div>
                            
                            <div class="form-group">
                                <label>City *</label>
                                <input type="text" id="city" class="form-input" required placeholder="Your city">
                            </div>
                            
                            <div class="form-group">
                                <label>Education Level *</label>
                                <select id="education" class="form-input" required>
                                    <option value="">Select Education Level</option>
                                    <option value="elementary">Elementary School</option>
                                    <option value="middle-school">Middle School</option>
                                    <option value="high-school">High School</option>
                                    <option value="some-college">Some College</option>
                                    <option value="associates">Associate's Degree</option>
                                    <option value="bachelors">Bachelor's Degree</option>
                                    <option value="masters">Master's Degree</option>
                                    <option value="doctorate">Doctorate/PhD</option>
                                    <option value="professional">Professional Degree</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Background</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                            <div class="form-group">
                                <label>Number of Siblings</label>
                                <input type="number" id="numSiblings" class="form-input" min="0" max="20" value="0" onchange="generateSiblingFields()">
                            </div>
                            
                            <div class="form-group">
                                <label>Birth Order</label>
                                <select id="birthOrder" class="form-input">
                                    <option value="">Select Birth Order</option>
                                    <option value="only-child">Only Child</option>
                                    <option value="eldest">Eldest Child</option>
                                    <option value="middle">Middle Child</option>
                                    <option value="youngest">Youngest Child</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Parents' Relationship Status</label>
                            <select id="parentsRelationship" class="form-input">
                                <option value="">Select Status</option>
                                <option value="married-happy">Married - Happy relationship</option>
                                <option value="married-strained">Married - Strained relationship</option>
                                <option value="divorced">Divorced</option>
                                <option value="separated">Separated</option>
                                <option value="single-parent">Single parent household</option>
                                <option value="deceased-parent">One parent deceased</option>
                                <option value="both-deceased">Both parents deceased</option>
                                <option value="adopted">Adopted</option>
                                <option value="foster">Foster care</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Quality of Relationship with Parents (1-10)</label>
                            <div class="range-container">
                                <input type="range" id="parentRelationship" class="range-input" min="1" max="10" value="5" oninput="updateRangeValue(this, 'parentRelationshipValue')">
                                <div class="range-labels">
                                    <span>Very Poor</span>
                                    <span>Average</span>
                                    <span>Excellent</span>
                                </div>
                                <div class="range-value" id="parentRelationshipValue">5</div>
                            </div>
                        </div>
                        
                        <div id="siblingFields"></div>
                        
                        <div class="form-group">
                            <label>Family Issues (Select all that apply)</label>
                            <div class="checkbox-grid">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="financial_stress" name="familyIssues">
                                    <label for="financial_stress">Financial stress</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="substance_abuse" name="familyIssues">
                                    <label for="substance_abuse">Substance abuse</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="domestic_violence" name="familyIssues">
                                    <label for="domestic_violence">Domestic violence</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="mental_illness" name="familyIssues">
                                    <label for="mental_illness">Mental illness in family</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="divorce_conflict" name="familyIssues">
                                    <label for="divorce_conflict">Divorce/separation conflict</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="neglect" name="familyIssues">
                                    <label for="neglect">Emotional/physical neglect</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="abuse" name="familyIssues">
                                    <label for="abuse">Physical/emotional abuse</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="communication_issues" name="familyIssues">
                                    <label for="communication_issues">Poor communication</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="none_family_issues" name="familyIssues">
                                    <label for="none_family_issues">None of the above</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Additional Family Information</label>
                            <textarea id="familyDetails" class="form-input" rows="4" placeholder="Describe any additional family dynamics, childhood experiences, or relationships that might be relevant..."></textarea>
                        </div>
                    </div>
                </form>
                
                <div class="navigation">
                    <button onclick="signOut()" class="btn btn-secondary">Sign Out</button>
                    <button onclick="savePersonalInfo()" class="btn btn-success">Save & Continue to Assessment</button>
                </div>
            </div>
        </div>
        
        <!-- Main Assessment Page -->
        <div id="assessmentPage" class="page">
            <div class="header">
                <h1>üß† Psychological Assessment</h1>
                <p>Comprehensive mental health and personality evaluation</p>
            </div>
            
            <div class="card">
                <div class="progress-container">
                    <div class="progress-bar" id="assessmentProgress"></div>
                </div>
                <div class="progress-text">Step 2 of 3 - Psychological Assessment</div>
                
                <!-- Rest of the assessment form from previous version -->
                <form id="psychologicalAssessment">
                    <!-- Critical Risk Assessment -->
                    <div class="section critical-section">
                        <h3>üÜò Critical Risk Assessment</h3>
                        
                        <div class="critical-question">
                            <label><strong>In the past two weeks, how often have you had thoughts of death or dying?</strong></label>
                            <select id="death_thoughts" class="form-input" required>
                                <option value="">Select an option</option>
                                <option value="never">Never</option>
                                <option value="rarely">Rarely (1-2 times)</option>
                                <option value="sometimes">Sometimes (3-6 times)</option>
                                <option value="often">Often (7-10 times)</option>
                                <option value="daily">Daily or almost daily</option>
                            </select>
                        </div>
                        
                        <!-- Additional critical questions from previous version -->
                    </div>
                    
                    <!-- Continue with all other sections from the previous assessment -->
                </form>
                
                <div class="navigation">
                    <button onclick="goToPersonalInfo()" class="btn btn-secondary">‚Üê Back</button>
                    <button onclick="generateAnalysis()" class="btn btn-success">Complete Assessment</button>
                </div>
            </div>
        </div>
        
        <!-- Results Page -->
        <div id="resultsPage" class="page">
            <div class="header">
                <h1>üìä Your Psychological Profile</h1>
                <p>Comprehensive analysis and personalized recommendations</p>
            </div>
            
            <div class="card">
                <div class="progress-container">
                    <div class="progress-bar" style="width: 100%;"></div>
                </div>
                <div class="progress-text">Step 3 of 3 - Complete Assessment Results</div>
                
                <div id="resultsContent">
                    <!-- Results will be dynamically generated here -->
                </div>
                
                <div class="navigation">
                    <button onclick="goToAssessment()" class="btn btn-secondary">‚Üê Retake Assessment</button>
                    <button onclick="downloadReport()" class="btn btn-success">üìÑ Download Report</button>
                    <button onclick="signOut()" class="btn btn-danger">Sign Out</button>
                </div>
            </div>
        </div>
        
        <!-- Loading Screen -->
        <div id="loadingScreen" class="loading">
            <div class="spinner"></div>
            <h3>Analyzing your responses...</h3>
            <p>Please wait while we generate your personalized psychological profile</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAqmJ4EbmNVn_Nupq_KWbCOIxBe0EznVbE",
            authDomain: "asim-phycology-program.firebaseapp.com",
            projectId: "asim-phycology-program",
            storageBucket: "asim-phycology-program.firebasestorage.app",
            messagingSenderId: "347139067902",
            appId: "1:347139067902:web:b8485bd83f9d045052faaf",
            measurementId: "G-2DR2K0DBBJ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let currentUser = null;
        let personalData = {};
        let assessmentData = {};
        
        // Authentication Functions
        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }
        
        function showLogin() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        }
        
        function signUp() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    showPersonalInfoPage();
                })
                .catch((error) => {
                    alert('Error: ' + error.message);
                });
        }
        
        function signIn() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    currentUser = userCredential.user;
                    loadUserData();
                })
                .catch((error) => {
                    alert('Error: ' + error.message);
                });
        }
        
        function signOut() {
            auth.signOut().then(() => {
                currentUser = null;
                personalData = {};
                assessmentData = {};
                showAuthPage();
            });
        }
        
        // Page Navigation Functions
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }
        
        function showAuthPage() {
            showPage('authPage');
        }
        
        function showPersonalInfoPage() {
            showPage('personalInfoPage');
            updatePersonalProgress();
        }
        
        function goToPersonalInfo() {
            showPersonalInfoPage();
        }
        
        function showAssessmentPage() {
            showPage('assessmentPage');
            updateAssessmentProgress();
        }
        
        function goToAssessment() {
            showAssessmentPage();
        }
        
        function showResultsPage() {
            showPage('resultsPage');
        }
        
        // Data Management Functions
        function loadUserData() {
            if (!currentUser) return;
            
            db.collection('users').doc(currentUser.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        if (userData.personalInfo) {
                            personalData = userData.personalInfo;
                            populatePersonalInfoForm();
                        }
                        if (userData.assessmentData) {
                            assessmentData = userData.assessmentData;
                            if (userData.hasCompletedAssessment) {
                                showResultsPage();
                                displayResults(userData.analysisResults);
                            } else {
                                showAssessmentPage();
                            }
                        } else {
                            showPersonalInfoPage();
                        }
                    } else {
                        showPersonalInfoPage();
                    }
                })
                .catch((error) => {
                    console.error("Error loading user data:", error);
                    showPersonalInfoPage();
                });
        }
        
        function savePersonalInfo() {
            if (!validatePersonalInfo()) {
                alert('Please fill in all required fields.');
                return;
            }
            
            collectPersonalData();
            
            if (!currentUser) {
                alert('Please sign in first.');
                return;
            }
            
            db.collection('users').doc(currentUser.uid).set({
                personalInfo: personalData,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true })
            .then(() => {
                showAssessmentPage();
            })
            .catch((error) => {
                console.error("Error saving personal info:", error);
                alert('Error saving data. Please try again.');
            });
        }
        
        function collectPersonalData() {
            personalData = {
                fullName: document.getElementById('fullName').value,
                age: parseInt(document.getElementById('age').value),
                gender: document.getElementById('gender').value,
                religion: document.getElementById('religion').value,
                ethnicity: document.getElementById('ethnicity').value,
                country: document.getElementById('country').value,
                city: document.getElementById('city').value,
                education: document.getElementById('education').value,
                numSiblings: parseInt(document.getElementById('numSiblings').value) || 0,
                birthOrder: document.getElementById('birthOrder').value,
                parentsRelationship: document.getElementById('parentsRelationship').value,
                parentRelationship: parseInt(document.getElementById('parentRelationship').value),
                familyDetails: document.getElementById('familyDetails').value,
                familyIssues: Array.from(document.querySelectorAll('input[name="familyIssues"]:checked')).map(cb => cb.id)
            };
            
            // Collect sibling relationship data
            const numSiblings = personalData.numSiblings;
            personalData.siblingRelationships = [];
            for (let i = 0; i < numSiblings; i++) {
                const relationshipElement = document.getElementById(`siblingRelationship${i}`);
                if (relationshipElement) {
                    personalData.siblingRelationships.push({
                        siblingNumber: i + 1,
                        relationship: parseInt(relationshipElement.value)
                    });
                }
            }
        }
        
        function populatePersonalInfoForm() {
            if (!personalData) return;
            
            document.getElementById('fullName').value = personalData.fullName || '';
            document.getElementById('age').value = personalData.age || '';
            document.getElementById('gender').value = personalData.gender || '';
            document.getElementById('religion').value = personalData.religion || '';
            document.getElementById('ethnicity').value = personalData.ethnicity || '';
            document.getElementById('country').value = personalData.country || '';
            document.getElementById('city').value = personalData.city || '';
            document.getElementById('education').value = personalData.education || '';
            document.getElementById('numSiblings').value = personalData.numSiblings || 0;
            document.getElementById('birthOrder').value = personalData.birthOrder || '';
            document.getElementById('parentsRelationship').value = personalData.parentsRelationship || '';
            document.getElementById('parentRelationship').value = personalData.parentRelationship || 5;
            document.getElementById('familyDetails').value = personalData.familyDetails || '';
            
            // Populate family issues checkboxes
            if (personalData.familyIssues) {
                personalData.familyIssues.forEach(issue => {
                    const checkbox = document.getElementById(issue);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            // Generate sibling fields
            generateSiblingFields();
            
            // Populate sibling relationships
            if (personalData.siblingRelationships) {
                personalData.siblingRelationships.forEach(sibling => {
                    const relationshipElement = document.getElementById(`siblingRelationship${sibling.siblingNumber - 1}`);
                    if (relationshipElement) {
                        relationshipElement.value = sibling.relationship;
                        updateRangeValue(relationshipElement, `siblingRelationshipValue${sibling.siblingNumber - 1}`);
                    }
                });
            }
        }
        
        function validatePersonalInfo() {
            const required = ['fullName', 'age', 'country', 'city', 'education'];
            return required.every(field => document.getElementById(field).value.trim() !== '');
        }
        
        // Dynamic Sibling Fields Generation
        function generateSiblingFields() {
            const numSiblings = parseInt(document.getElementById('numSiblings').value) || 0;
            const container = document.getElementById('siblingFields');
            
            container.innerHTML = '';
            
            if (numSiblings > 0) {
                const siblingSection = document.createElement('div');
                siblingSection.className = 'family-member';
                siblingSection.innerHTML = `<h4>üë´ Sibling Relationships</h4>`;
                
                for (let i = 0; i < numSiblings; i++) {
                    const siblingDiv = document.createElement('div');
                    siblingDiv.className = 'form-group';
                    siblingDiv.innerHTML = `
                        <label>Relationship Quality with Sibling ${i + 1} (1-10)</label>
                        <div class="range-container">
                            <input type="range" id="siblingRelationship${i}" class="range-input" min="1" max="10" value="5" oninput="updateRangeValue(this, 'siblingRelationshipValue${i}')">
                            <div class="range-labels">
                                <span>Very Poor</span>
                                <span>Average</span>
                                <span>Excellent</span>
                            </div>
                            <div class="range-value" id="siblingRelationshipValue${i}">5</div>
                        </div>
                    `;
                    siblingSection.appendChild(siblingDiv);
                }
                
                container.appendChild(siblingSection);
            }
        }
        
        // Progress Tracking
        function updatePersonalProgress() {
            const form = document.getElementById('personalInfoForm');
            const inputs = form.querySelectorAll('input, select, textarea');
            let filled = 0;
            let total = 0;
            
            inputs.forEach(input => {
                if (input.type === 'checkbox') return;
                total++;
                if (input.value !== '' && input.value !== '5') {
                    filled++;
                }
            });
            
            const progress = (filled / total) * 100;
            document.getElementById('personalProgress').style.width = progress + '%';
        }
        
        function updateAssessmentProgress() {
            const form = document.getElementById('psychologicalAssessment');
            const inputs = form.querySelectorAll('input, select, textarea');
            let filled = 0;
            let total = 0;
            
            inputs.forEach(input => {
                if (input.type === 'checkbox') return;
                total++;
                if (input.value !== '' && input.value !== '5') {
                    filled++;
                }
            });
            
            const progress = (filled / total) * 100;
            document.getElementById('assessmentProgress').style.width = progress + '%';
        }
        
        // Range Input Updates
        function updateRangeValue(slider, valueId) {
            document.getElementById(valueId).textContent = slider.value;
            updatePersonalProgress();
            updateAssessmentProgress();
        }
        
        // Assessment Analysis Functions
        function generateAnalysis() {
            if (!validateAssessment()) {
                alert('Please complete all required fields in the assessment.');
                return;
            }
            
            collectAssessmentData();
            showLoadingScreen();
            
            setTimeout(() => {
                const analysis = performComprehensiveAnalysis();
                saveAnalysisResults(analysis);
                hideLoadingScreen();
                showResultsPage();
                displayResults(analysis);
            }, 3000);
        }
        
        function collectAssessmentData() {
            const form = document.getElementById('psychologicalAssessment');
            const inputs = form.querySelectorAll('input, select, textarea');
            
            assessmentData = {};
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    if (!assessmentData[input.name]) assessmentData[input.name] = [];
                    if (input.checked) assessmentData[input.name].push(input.id);
                } else {
                    assessmentData[input.id] = input.value;
                }
            });
        }
        
        function validateAssessment() {
            const requiredFields = ['death_thoughts', 'self_harm_thoughts', 'suicide_plan'];
            return requiredFields.every(field => {
                const element = document.getElementById(field);
                return element && element.value !== '';
            });
        }
        
        function performComprehensiveAnalysis() {
            // Comprehensive analysis combining personal background and assessment data
            const suicidalRisk = assessSuicidalRisk(assessmentData);
            const empathyLevel = assessEmpathy(assessmentData);
            const narcissisticTraits = assessNarcissism(assessmentData);
            const antisocialTraits = assessAntisocial(assessmentData);
            const mentalHealthScore = calculateMentalHealthScore(assessmentData);
            const familyInfluence = analyzeFamilyInfluence(personalData);
            const personalityType = determinePersonalityType(empathyLevel, narcissisticTraits, antisocialTraits, suicidalRisk);
            
            return {
                personalInfo: personalData,
                suicidalRisk,
                empathyLevel,
                narcissisticTraits,
                antisocialTraits,
                mentalHealthScore,
                familyInfluence,
                personalityType,
                recommendations: generatePersonalizedRecommendations(personalData, suicidalRisk, empathyLevel, narcissisticTraits, antisocialTraits, mentalHealthScore, familyInfluence),
                detailedPlan: createDetailedTreatmentPlan(personalData, suicidalRisk, empathyLevel, narcissisticTraits, antisocialTraits, mentalHealthScore, familyInfluence),
                timestamp: new Date().toISOString()
            };
        }
        
        function analyzeFamilyInfluence(personalData) {
            let familyScore = 0;
            let riskFactors = [];
            let protectiveFactors = [];
            
            // Analyze family relationship quality
            if (personalData.parentRelationship) {
                if (personalData.parentRelationship >= 8) {
                    protectiveFactors.push('Strong parental relationship');
                    familyScore += 2;
                } else if (personalData.parentRelationship <= 3) {
                    riskFactors.push('Poor parental relationship');
                    familyScore -= 2;
                }
            }
            
            // Analyze family structure
            if (personalData.parentsRelationship) {
                if (personalData.parentsRelationship === 'married-happy') {
                    protectiveFactors.push('Stable family structure');
                    familyScore += 1;
                } else if (['divorced', 'separated', 'single-parent'].includes(personalData.parentsRelationship)) {
                    riskFactors.push('Family structure disruption');
                    familyScore -= 1;
                }
            }
            
            // Analyze family issues
            if (personalData.familyIssues && personalData.familyIssues.length > 0) {
                const seriousIssues = ['domestic_violence', 'substance_abuse', 'abuse', 'neglect', 'mental_illness'];
                const hasSerious = personalData.familyIssues.some(issue => seriousIssues.includes(issue));
                
                if (hasSerious) {
                    riskFactors.push('Serious family dysfunction');
                    familyScore -= 3;
                } else if (personalData.familyIssues.length > 2) {
                    riskFactors.push('Multiple family stressors');
                    familyScore -= 1;
                }
            }
            
            // Sibling relationships
            if (personalData.siblingRelationships && personalData.siblingRelationships.length > 0) {
                const avgSiblingRelation = personalData.siblingRelationships.reduce((sum, rel) => sum + rel.relationship, 0) / personalData.siblingRelationships.length;
                if (avgSiblingRelation >= 7) {
                    protectiveFactors.push('Strong sibling bonds');
                    familyScore += 1;
                } else if (avgSiblingRelation <= 3) {
                    riskFactors.push('Poor sibling relationships');
                    familyScore -= 1;
                }
            }
            
            let influence = 'Neutral';
            if (familyScore >= 3) influence = 'Very Protective';
            else if (familyScore >= 1) influence = 'Protective';
            else if (familyScore <= -3) influence = 'High Risk';
            else if (familyScore <= -1) influence = 'Risk Factor';
            
            return {
                score: familyScore,
                influence,
                riskFactors,
                protectiveFactors
            };
        }
        
        function createDetailedTreatmentPlan(personalData, suicidalRisk, empathyLevel, narcissisticTraits, antisocialTraits, mentalHealthScore, familyInfluence) {
            const plan = {
                immediate: [],
                shortTerm: [],
                longTerm: [],
                familyFocus: [],
                culturalConsiderations: []
            };
            
            // Immediate interventions
            if (suicidalRisk.score >= 8) {
                plan.immediate.push('üö® EMERGENCY: Contact crisis services immediately');
                plan.immediate.push('üìû Establish 24/7 support network');
                plan.immediate.push('üè• Inpatient psychiatric evaluation');
            } else if (suicidalRisk.score >= 5) {
                plan.immediate.push('üë®‚Äç‚öïÔ∏è Schedule urgent psychiatric evaluation within 48 hours');
                plan.immediate.push('üîí Remove potential means of self-harm');
                plan.immediate.push('üì± Install crisis support apps');
            }
            
            // Short-term (1-3 months)
            if (narcissisticTraits.score >= 8) {
                plan.shortTerm.push('ü™û Begin Dialectical Behavior Therapy (DBT)');
                plan.shortTerm.push('üë• Group therapy for personality development');
            }
            
            if (antisocialTraits.score >= 8) {
                plan.shortTerm.push('‚öñÔ∏è Cognitive-behavioral therapy focusing on empathy building');
                plan.shortTerm.push('üéØ Moral reasoning training');
            }
            
            if (empathyLevel.percentage < 30) {
                plan.shortTerm.push('‚ù§Ô∏è Empathy training exercises');
                plan.shortTerm.push('üìö Emotional intelligence workshops');
            }
            
            // Long-term (6+ months)
            plan.longTerm.push('üß† Regular psychiatric follow-ups every 3-6 months');
            plan.longTerm.push('üíä Medication management if indicated');
            plan.longTerm.push('üéØ Develop healthy coping mechanisms');
            
            // Family-focused interventions
            if (familyInfluence.riskFactors.length > 0) {
                plan.familyFocus.push('üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family therapy sessions');
                plan.familyFocus.push('üó£Ô∏è Improve family communication patterns');
                if (personalData.familyIssues.includes('domestic_violence') || personalData.familyIssues.includes('abuse')) {
                    plan.familyFocus.push('üõ°Ô∏è Safety planning and protective measures');
                }
            }
            
            // Cultural considerations
            if (personalData.religion && personalData.religion !== 'atheist') {
                plan.culturalConsiderations.push('üôè Incorporate spiritual/religious counseling');
                plan.culturalConsiderations.push('‚õ™ Connect with faith-based support systems');
            }
            
            if (personalData.ethnicity && personalData.ethnicity !== 'white-caucasian') {
                plan.culturalConsiderations.push('üåç Culturally-sensitive therapy approaches');
                plan.culturalConsiderations.push('üë• Connect with culturally-matched support groups');
            }
            
            return plan;
        }
        
        function generatePersonalizedRecommendations(personalData, suicidalRisk, empathyLevel, narcissisticTraits, antisocialTraits, mentalHealthScore, familyInfluence) {
            const recommendations = [];
            
            // Age-specific recommendations
            if (personalData.age < 18) {
                recommendations.push({
                    type: 'AGE-SPECIFIC',
                    text: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Involve parents/guardians in treatment planning (if safe)',
                    color: '#9b59b6'
                });
                recommendations.push({
                    type: 'EDUCATION',
                    text: 'üéì School counseling and academic support services',
                    color: '#3498db'
                });
            } else if (personalData.age >= 65) {
                recommendations.push({
                    type: 'AGE-SPECIFIC',
                    text: 'üë¥ Geriatric mental health specialist consultation',
                    color: '#9b59b6'
                });
            }
            
            // Education-based recommendations
            if (personalData.education === 'elementary' || personalData.education === 'middle-school') {
                recommendations.push({
                    type: 'EDUCATION',
                    text: 'üìö Consider continuing education for improved mental health outcomes',
                    color: '#e67e22'
                });
            }
            
            // Family-specific recommendations
            if (familyInfluence.score < -2) {
                recommendations.push({
                    type: 'FAMILY',
                    text: 'üè† Consider family therapy or mediation services',
                    color: '#e74c3c'
                });
            }
            
            // Continue with existing recommendation logic...
            // (Include all the recommendation logic from the previous version)
            
            return recommendations;
        }
        
        function saveAnalysisResults(analysis) {
            if (!currentUser) return;
            
            db.collection('users').doc(currentUser.uid).update({
                assessmentData: assessmentData,
                analysisResults: analysis,
                hasCompletedAssessment: true,
                completionDate: firebase.firestore.FieldValue.serverTimestamp()
            })
            .catch((error) => {
                console.error("Error saving analysis results:", error);
            });
        }
        
        function displayResults(analysis) {
            const container = document.getElementById('resultsContent');
            
            const personalInfo = analysis.personalInfo;
            const familyInfo = analysis.familyInfluence;
            
            container.innerHTML = `
                <div class="section">
                    <h3>üë§ Personal Profile Summary</h3>
                    <div class="metric-grid">
                        <div class="metric-card">
                            <h4>${personalInfo.fullName}</h4>
                            <p>Age: ${personalInfo.age} | ${personalInfo.gender || 'Not specified'}</p>
                            <p>üìç ${personalInfo.city}, ${personalInfo.country}</p>
                            <p>üéì ${personalInfo.education || 'Not specified'}</p>
                        </div>
                        <div class="metric-card">
                            <h4>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Background</h4>
                            <p>Siblings: ${personalInfo.numSiblings || 0}</p>
                            <p>Birth Order: ${personalInfo.birthOrder || 'Not specified'}</p>
                            <p>Parent Relationship: ${personalInfo.parentRelationship}/10</p>
                        </div>
                        <div class="metric-card" style="border-left-color: ${getFamilyInfluenceColor(familyInfo.influence)};">
                            <h4>üè† Family Influence</h4>
                            <p style="color: ${getFamilyInfluenceColor(familyInfo.influence)}; font-weight: bold;">
                                ${familyInfo.influence}
                            </p>
                            <p>Score: ${familyInfo.score}</p>
                        </div>
                    </div>
                    
                    ${familyInfo.riskFactors.length > 0 ? `
                    <div style="background: #fef2f2; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #e74c3c;">
                        <h4 style="color: #e74c3c;">‚ö†Ô∏è Family Risk Factors:</h4>
                        ${familyInfo.riskFactors.map(factor => `<p>‚Ä¢ ${factor}</p>`).join('')}
                    </div>
                    ` : ''}
                    
                    ${familyInfo.protectiveFactors.length > 0 ? `
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #2ecc71;">
                        <h4 style="color: #2ecc71;">‚úÖ Protective Factors:</h4>
                        ${familyInfo.protectiveFactors.map(factor => `<p>‚Ä¢ ${factor}</p>`).join('')}
                    </div>
                    ` : ''}
                </div>
                
                <div class="section">
                    <h3>üìä Psychological Assessment Results</h3>
                    <div class="metric-grid">
                        <div class="metric-card" style="border-left-color: ${getSuicidalRiskColor(analysis.suicidalRisk.score)};">
                            <h4>üÜò Suicidal Risk</h4>
                            <div style="font-size: 24px; color: ${getSuicidalRiskColor(analysis.suicidalRisk.score)}; font-weight: bold;">
                                ${analysis.suicidalRisk.level}
                            </div>
                            <p>Score: ${analysis.suicidalRisk.score}/20</p>
                        </div>
                        
                        <div class="metric-card" style="border-left-color: #059669;">
                            <h4>‚ù§Ô∏è Empathy Level</h4>
                            <div style="font-size: 24px; color: #059669; font-weight: bold;">
                                ${analysis.empathyLevel.level}
                            </div>
                            <p>${analysis.empathyLevel.percentage}% Score</p>
                        </div>
                        
                        <div class="metric-card" style="border-left-color: ${analysis.personalityType.color};">
                            <h4>üé≠ Personality Type</h4>
                            <div style="font-size: 18px; color: ${analysis.personalityType.color}; font-weight: bold;">
                                ${analysis.personalityType.type}
                            </div>
                        </div>
                        
                        <div class="metric-card" style="border-left-color: #0891b2;">
                            <h4>üß† Mental Health</h4>
                            <div style="font-size: 24px; color: #0891b2; font-weight: bold;">
                                ${analysis.mentalHealthScore}/10
                            </div>
                            <p>Overall Wellbeing</p>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>üìã Detailed Treatment Plan</h3>
                    
                    ${analysis.detailedPlan.immediate.length > 0 ? `
                    <div style="background: #fef2f2; padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #e74c3c;">
                        <h4 style="color: #e74c3c;">üö® Immediate Actions (Next 24-48 hours):</h4>
                        ${analysis.detailedPlan.immediate.map(action => `<p>‚Ä¢ ${action}</p>`).join('')}
                    </div>
                    ` : ''}
                    
                    ${analysis.detailedPlan.shortTerm.length > 0 ? `
                    <div style="background: #fff8dc; padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #f39c12;">
                        <h4 style="color: #f39c12;">üìÖ Short-term Goals (1-3 months):</h4>
                        ${analysis.detailedPlan.shortTerm.map(goal => `<p>‚Ä¢ ${goal}</p>`).join('')}
                    </div>
                    ` : ''}
                    
                    ${analysis.detailedPlan.longTerm.length > 0 ? `
                    <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #3498db;">
                        <h4 style="color: #3498db;">üéØ Long-term Strategy (6+ months):</h4>
                        ${analysis.detailedPlan.longTerm.map(strategy => `<p>‚Ä¢ ${strategy}</p>`).join('')}
                    </div>
                    ` : ''}
                    
                    ${analysis.detailedPlan.familyFocus.length > 0 ? `
                    <div style="background: #f5f3ff; padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #8b5cf6;">
                        <h4 style="color: #8b5cf6;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family-Focused Interventions:</h4>
                        ${analysis.detailedPlan.familyFocus.map(intervention => `<p>‚Ä¢ ${intervention}</p>`).join('')}
                    </div>
                    ` : ''}
                    
                    ${analysis.detailedPlan.culturalConsiderations.length > 0 ? `
                    <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #22c55e;">
                        <h4 style="color: #22c55e;">üåç Cultural Considerations:</h4>
                        ${analysis.detailedPlan.culturalConsiderations.map(consideration => `<p>‚Ä¢ ${consideration}</p>`).join('')}
                    </div>
                    ` : ''}
                </div>
                
                <div class="disclaimer">
                    <h4>‚ö†Ô∏è Important Medical Disclaimer</h4>
                    <p><strong>This assessment is for informational and research purposes only.</strong></p>
                    <ul style="margin: 10px 0 0 20px;">
                        <li>Not a substitute for professional medical or psychological diagnosis</li>
                        <li>Results should be discussed with qualified mental health professionals</li>
                        <li>In case of emergency, contact your local crisis helpline or emergency services</li>
                        <li>Crisis Support: National Suicide Prevention Lifeline: 988</li>
                        <li>Your data contributes to mental health research (anonymized)</li>
                    </ul>
                </div>
            `;
        }
        
        // Helper Functions
        function getSuicidalRiskColor(score) {
            if (score >= 8) return '#dc2626';
            if (score >= 5) return '#ea580c';
            if (score >= 3) return '#d97706';
            return '#059669';
        }
        
        function getFamilyInfluenceColor(influence) {
            switch(influence) {
                case 'Very Protective': return '#22c55e';
                case 'Protective': return '#10b981';
                case 'Neutral': return '#6b7280';
                case 'Risk Factor': return '#f59e0b';
                case 'High Risk': return '#dc2626';
                default: return '#6b7280';
            }
        }
        
        function showLoadingScreen() {
            document.getElementById('loadingScreen').style.display = 'block';
        }
        
        function hideLoadingScreen() {
            document.getElementById('loadingScreen').style.display = 'none';
        }
        
        function downloadReport() {
            // Generate and download PDF report
            const reportContent = document.getElementById('resultsContent').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>MindScan Pro - Psychological Assessment Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .section { margin-bottom: 30px; }
                        .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
                        .metric-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
                        h3 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
                        .disclaimer { background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 30px; }
                    </style>
                </head>
                <body>
                    <h1>üß† MindScan Pro - Comprehensive Psychological Assessment Report</h1>
                    <p>Generated on: ${new Date().toLocaleDateString()}</p>
                    <hr>
                    ${reportContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        // Assessment Analysis Functions (from previous version)
        function assessSuicidalRisk(data) {
            let riskScore = 0;
            let riskLevel = 'Low';
            let criticalFlags = [];
            
            // Death thoughts
            const deathThoughts = data.death_thoughts;
            if (deathThoughts === 'daily') { riskScore += 4; criticalFlags.push('Daily death thoughts'); }
            else if (deathThoughts === 'often') { riskScore += 3; criticalFlags.push('Frequent death thoughts'); }
            else if (deathThoughts === 'sometimes') { riskScore += 2; }
            else if (deathThoughts === 'rarely') { riskScore += 1; }
            
            // Self-harm thoughts
            const selfHarmThoughts = data.self_harm_thoughts;
            if (selfHarmThoughts === 'today') { riskScore += 5; criticalFlags.push('IMMEDIATE RISK: Suicidal thoughts today'); }
            else if (selfHarmThoughts === 'past_week') { riskScore += 4; criticalFlags.push('Recent suicidal thoughts'); }
            else if (selfHarmThoughts === 'past_month') { riskScore += 3; criticalFlags.push('Recent suicidal ideation'); }
            else if (selfHarmThoughts === 'past_not_recent') { riskScore += 1; }
            
            // Suicide plan
            const suicidePlan = data.suicide_plan;
            if (suicidePlan === 'prepared') { riskScore += 6; criticalFlags.push('CRITICAL: Has plan and means'); }
            else if (suicidePlan === 'specific') { riskScore += 4; criticalFlags.push('Has specific suicide plan'); }
            else if (suicidePlan === 'vague') { riskScore += 2; }
            
            // Previous attempts
            const attempts = data.suicide_attempt;
            if (attempts === 'past_month') { riskScore += 5; criticalFlags.push('Recent suicide attempt'); }
            else if (attempts === 'past_year') { riskScore += 3; criticalFlags.push('Suicide attempt within year'); }
            else if (attempts === 'multiple') { riskScore += 4; criticalFlags.push('Multiple suicide attempts'); }
            else if (attempts === 'considered') { riskScore += 1; }
            
            // Determine risk level
            if (riskScore >= 8) {
                riskLevel = 'CRITICAL - IMMEDIATE INTERVENTION REQUIRED';
            } else if (riskScore >= 5) {
                riskLevel = 'HIGH - Professional help needed urgently';
            } else if (riskScore >= 3) {
                riskLevel = 'MODERATE - Professional evaluation recommended';
            } else if (riskScore >= 1) {
                riskLevel = 'LOW-MODERATE - Monitor closely';
            }
            
            return { score: riskScore, level: riskLevel, flags: criticalFlags };
        }
        
        function assessEmpathy(data) {
            let empathyScore = 0;
            
            // Emotional responses
            empathyScore += parseInt(data.empathy_crying) || 5;
            empathyScore += parseInt(data.emotion_reading) || 5;
            
            // Scenario responses
            const scenario1 = data.empathy_scenario1;
            if (scenario1 === 'deeply_moved') empathyScore += 10;
            else if (scenario1 === 'emotional') empathyScore += 8;
            else if (scenario1 === 'practical') empathyScore += 5;
            else if (scenario1 === 'self_focused') empathyScore += 2;
            else if (scenario1 === 'detached') empathyScore += 1;
            
            // Movie empathy
            const movieEmpathy = data.movie_empathy;
            if (movieEmpathy === 'overwhelmed') empathyScore += 10;
            else if (movieEmpathy === 'cry') empathyScore += 8;
            else if (movieEmpathy === 'moderately') empathyScore += 6;
            else if (movieEmpathy === 'slightly') empathyScore += 3;
            else if (movieEmpathy === 'unaffected') empathyScore += 0;
            
            // Perspective taking
            const perspectiveTaking = data.perspective_taking;
            if (perspectiveTaking === 'always') empathyScore += 8;
            else if (perspectiveTaking === 'often') empathyScore += 6;
            else if (perspectiveTaking === 'sometimes') empathyScore += 4;
            else if (perspectiveTaking === 'rarely') empathyScore += 2;
            else if (perspectiveTaking === 'never') empathyScore += 0;
            
            // Calculate level
            const maxScore = 46;
            const percentage = (empathyScore / maxScore) * 100;
            
            let level = 'Normal';
            if (percentage >= 80) level = 'Highly Empathetic';
            else if (percentage >= 60) level = 'Above Average Empathy';
            else if (percentage >= 40) level = 'Average Empathy';
            else if (percentage >= 20) level = 'Below Average Empathy';
            else level = 'Very Low Empathy';
            
            return { score: empathyScore, percentage: Math.round(percentage), level };
        }
        
        function assessNarcissism(data) {
            let narcScore = 0;
            let traits = [];
            
            // Grandiosity
            const specialness = parseInt(data.specialness) || 5;
            if (specialness >= 8) { narcScore += 3; traits.push('Grandiose self-view'); }
            else if (specialness >= 6) { narcScore += 1; }
            
            // Entitlement
            const entitlement = data.entitlement;
            if (entitlement === 'always') { narcScore += 4; traits.push('Strong sense of entitlement'); }
            else if (entitlement === 'often') { narcScore += 3; traits.push('Entitlement tendencies'); }
            else if (entitlement === 'sometimes') { narcScore += 1; }
            
            // Need for admiration
            const admirationNeed = parseInt(data.admiration_need) || 5;
            if (admirationNeed >= 8) { narcScore += 3; traits.push('High need for admiration'); }
            else if (admirationNeed >= 6) { narcScore += 1; }
            
            // Grandiose fantasies
            const fantasies = data.grandiose_fantasies;
            if (fantasies === 'constantly') { narcScore += 4; traits.push('Grandiose fantasies'); }
            else if (fantasies === 'often') { narcScore += 3; traits.push('Frequent power fantasies'); }
            else if (fantasies === 'sometimes') { narcScore += 1; }
            
            // Promotion reaction
            const promotionReaction = data.promotion_reaction;
            if (promotionReaction === 'superior') { narcScore += 3; traits.push('Superiority complex'); }
            else if (promotionReaction === 'angry') { narcScore += 2; traits.push('Poor handling of rejection'); }
            else if (promotionReaction === 'unfair') { narcScore += 1; }
            
            let level = 'Normal';
            if (narcScore >= 12) level = 'High Narcissistic Traits';
            else if (narcScore >= 8) level = 'Moderate Narcissistic Traits';
            else if (narcScore >= 4) level = 'Some Narcissistic Traits';
            
            return { score: narcScore, level, traits };
        }
        
        function assessAntisocial(data) {
            let antisocialScore = 0;
            let traits = [];
            
            // Rule breaking
            const ruleBreaking = data.rule_breaking;
            if (ruleBreaking === 'no_problem') { antisocialScore += 4; traits.push('Disregard for rules'); }
            else if (ruleBreaking === 'often') { antisocialScore += 3; traits.push('Frequent rule breaking'); }
            else if (ruleBreaking === 'minor_ok') { antisocialScore += 1; }
            
            // Wallet scenario
            const walletScenario = data.wallet_scenario;
            if (walletScenario === 'keep_all') { antisocialScore += 4; traits.push('Lack of honesty/empathy'); }
            else if (walletScenario === 'return_no_cash') { antisocialScore += 3; traits.push('Opportunistic dishonesty'); }
            else if (walletScenario === 'return_minus') { antisocialScore += 2; traits.push('Minor dishonesty'); }
            else if (walletScenario === 'depends') { antisocialScore += 1; }
            
            // Guilt and remorse
            const guiltRemorse = data.guilt_remorse;
            if (guiltRemorse === 'never') { antisocialScore += 4; traits.push('Lack of remorse'); }
            else if (guiltRemorse === 'rarely') { antisocialScore += 3; traits.push('Limited guilt/remorse'); }
            else if (guiltRemorse === 'sometimes') { antisocialScore += 1; }
            
            // Deception ease
            const deceptionEase = parseInt(data.deception_ease) || 5;
            if (deceptionEase >= 8) { antisocialScore += 3; traits.push('Ease with deception'); }
            else if (deceptionEase >= 6) { antisocialScore += 1; }
            
            // View of trusting people
            const trustView = data.trust_view;
            if (trustView === 'contempt') { antisocialScore += 4; traits.push('Contempt for others'); }
            else if (trustView === 'exploitable') { antisocialScore += 4; traits.push('Exploitative mindset'); }
            else if (trustView === 'weak') { antisocialScore += 2; traits.push('Views others as weak'); }
            
            let level = 'Normal';
            if (antisocialScore >= 12) level = 'High Antisocial Traits';
            else if (antisocialScore >= 8) level = 'Moderate Antisocial Traits';
            else if (antisocialScore >= 4) level = 'Some Antisocial Traits';
            
            return { score: antisocialScore, level, traits };
        }
        
        function calculateMentalHealthScore(data) {
            const mood = parseInt(data.mood) || 5;
            const anxiety = parseInt(data.anxiety) || 5;
            const energy = parseInt(data.energy) || 5;
            const sleepQuality = parseInt(data.sleep_quality) || 5;
            
            const positiveAvg = (mood + energy + sleepQuality) / 3;
            const overallScore = ((positiveAvg + (10 - anxiety)) / 2).toFixed(1);
            
            return parseFloat(overallScore);
        }
        
        function determinePersonalityType(empathy, narcissism, antisocial, suicidalRisk) {
            const types = [];
            
            // Critical risk assessment
            if (suicidalRisk.score >= 5) {
                types.push({ type: 'At-Risk Individual', color: '#dc2626', priority: 1 });
            }
            
            // Psychopathic traits (low empathy + high antisocial)
            if (empathy.percentage < 30 && antisocial.score >= 8) {
                types.push({ type: 'Psychopathic Traits', color: '#7c2d12', priority: 2 });
            }
            
            // Narcissistic traits
            if (narcissism.score >= 8) {
                types.push({ type: 'Narcissistic Traits', color: '#a21caf', priority: 3 });
            }
            
            // Antisocial traits
            if (antisocial.score >= 8) {
                types.push({ type: 'Antisocial Traits', color: '#be123c', priority: 4 });
            }
            
            // High empathy
            if (empathy.percentage >= 70) {
                types.push({ type: 'Highly Empathetic', color: '#059669', priority: 5 });
            }
            
            // Normal/healthy
            if (types.length === 0 || (empathy.percentage >= 40 && narcissism.score < 6 && antisocial.score < 4)) {
                types.push({ type: 'Normal/Healthy Range', color: '#0d9488', priority: 6 });
            }
            
            // Sort by priority and return primary type
            types.sort((a, b) => a.priority - b.priority);
            return types[0] || { type: 'Unclassified', color: '#6b7280', priority: 7 };
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    loadUserData();
                } else {
                    showAuthPage();
                }
            });
            
            // Add event listeners for form changes
            document.addEventListener('change', function() {
                updatePersonalProgress();
                updateAssessmentProgress();
            });
            
            document.addEventListener('input', function() {
                updatePersonalProgress();
                updateAssessmentProgress();
            });
        });
        
        // Add the complete assessment form content from the previous version
        // This includes all the psychological assessment questions
        function addAssessmentContent() {
            const assessmentContainer = document.getElementById('psychologicalAssessment');
            
            assessmentContainer.innerHTML = `
                <!-- Critical Risk Assessment -->
                <div class="section critical-section">
                    <h3>üÜò Critical Risk Assessment</h3>
                    
                    <div class="critical-question">
                        <label><strong>In the past two weeks, how often have you had thoughts of death or dying?</strong></label>
                        <select id="death_thoughts" class="form-input" required>
                            <option value="">Select an option</option>
                            <option value="never">Never</option>
                            <option value="rarely">Rarely (1-2 times)</option>
                            <option value="sometimes">Sometimes (3-6 times)</option>
                            <option value="often">Often (7-10 times)</option>
                            <option value="daily">Daily or almost daily</option>
                        </select>
                    </div>
                    
                    <div class="critical-question">
                        <label><strong>Have you ever had thoughts of hurting yourself or ending your life?</strong></label>
                        <select id="self_harm_thoughts" class="form-input" required>
                            <option value="">Select an option</option>
                            <option value="never">Never</option>
                            <option value="past_not_recent">Yes, but not recently</option>
                            <option value="past_month">Yes, in the past month</option>
                            <option value="past_week">Yes, in the past week</option>
                            <option value="today">Yes, today</option>
                        </select>
                    </div>
                    
                    <div class="critical-question">
                        <label><strong>Do you have a specific plan for how you would hurt yourself?</strong></label>
                        <select id="suicide_plan" class="form-input" required>
                            <option value="">Select an option</option>
                            <option value="no">No</option>
                            <option value="vague">Vague thoughts but no specific plan</option>
                            <option value="specific">Yes, I have a specific plan</option>
                            <option value="prepared">Yes, and I have access to means</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Have you ever attempted to hurt yourself or end your life?</label>
                        <select id="suicide_attempt" class="form-input">
                            <option value="never">Never</option>
                            <option value="considered">Considered but never attempted</option>
                            <option value="past_year">Yes, in the past year</option>
                            <option value="past_month">Yes, in the past month</option>
                            <option value="multiple">Yes, multiple times</option>
                        </select>
                    </div>
                </div>
                
                <!-- Empathy Assessment -->
                <div class="section">
                    <h3>‚ù§Ô∏è Empathy & Emotional Intelligence</h3>
                    
                    <div class="form-group">
                        <label>When you see someone crying, how do you typically feel? (1-10):</label>
                        <div class="range-container">
                            <input type="range" id="empathy_crying" class="range-input" min="1" max="10" value="5" oninput="updateRangeValue(this, 'empathyCryingValue')">
                            <div class="range-labels">
                                <span>Indifferent/Annoyed</span>
                                <span>Somewhat Moved</span>
                                <span>Deeply Affected</span>
                            </div>
                            <div class="range-value" id="empathyCryingValue">5</div>
                        </div>
                    </div>
                    
                    <div class="scenario-box">
                        <label><strong>Scenario:</strong> A friend tells you they lost their job and are worried about paying rent. Your first reaction is:</label>
                        <select id="empathy_scenario1" class="form-input">
                            <option value="practical">Immediately offer practical advice</option>
                            <option value="emotional">Feel their worry and offer emotional support first</option>
                            <option value="detached">Think they probably made mistakes that led to this</option>
                            <option value="self_focused">Worry about how this affects your plans together</option>
                            <option value="deeply_moved">Feel genuinely distressed by their situation</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>How easily can you tell what others are feeling just by looking at them? (1-10):</label>
                        <div class="range-container">
                            <input type="range" id="emotion_reading" class="range-input" min="1" max="10" value="5" oninput="updateRangeValue(this, 'emotionReadingValue')">
                            <div class="range-labels">
                                <span>Very Difficult</span>
                                <span>Sometimes</span>
                                <span>Very Easy</span>
                            </div>
                            <div class="range-value" id="emotionReadingValue">5</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>When watching a sad movie, do you:</label>
                        <select id="movie_empathy" class="form-input">
                            <option value="unaffected">Remain emotionally unaffected</option>
                            <option value="slightly">Feel slightly moved</option>
                            <option value="moderately">Feel moderately emotional</option>
                            <option value="cry">Often cry or feel deeply moved</option>
                            <option value="overwhelmed">Become overwhelmed with emotion</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>How often do you put yourself in others' shoes before judging them?</label>
                        <select id="perspective_taking" class="form-input">
                            <option value="never">Never</option>
                            <option value="rarely">Rarely</option>
                            <option value="sometimes">Sometimes</option>
                            <option value="often">Often</option>
                            <option value="always">Always</option>
                        </select>
                    </div>
                </div>
                
                <!-- Continue with other sections... -->
                <!-- Add all remaining assessment sections from the previous version -->
            `;
        }
        
        // Initialize assessment content when page loads
        setTimeout(addAssessmentContent, 1000);
    </script>
</body>
</html>
        